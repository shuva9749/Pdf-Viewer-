<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Google Drive and Dropbox File Picker</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: #eef2fb;
      padding: 20px;
      text-align: center;
    }
    .button-group {
      display: flex;
      justify-content: center;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .button-group button, .button-group label {
      background-color: #1a73e8;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 1rem;
      border-radius: 5px;
      cursor: pointer;
    }
    .button-group button.dropbox-button {
      background-color: #0061FF;
    }
    #content iframe {
      width: 100%;
      height: 600px;
      border: none;
      margin-top: 20px;
    }
  </style>
</head>
<body>

  <h1>Google Drive & Dropbox File Picker</h1>

  <div class="button-group">
    <button id="authorize_button" onclick="handleAuthClick()">
      <img src="https://ssl.gstatic.com/images/branding/product/1x/drive_2020q4_48dp.png" alt="Google Drive Logo" style="height:20px"/> Google Drive
    </button>

    <button class="dropbox-button" id="dropbox-picker">
      <i class="fab fa-dropbox"></i> Dropbox
    </button>

    <label for="my_device_input">
      <i class="fas fa-folder-open"></i> My Device
    </label>
    <input type="file" id="my_device_input" accept="application/pdf" multiple onchange="handleLocalFiles(event)" style="display:none;" />
  </div>

  <div id="content"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    const CLIENT_ID = '705204588232-3m2bivi6c0nd41lgpe7j34abim8s0gta.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyAs1-yX51Kd5aKl-mB1oHhKXhOwCUDcPUY';
    const APP_ID = '705204588232';
    const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';

    let tokenClient;
    let accessToken = null;
    let pickerInited = false;
    let gisInited = false;

    document.getElementById('authorize_button').style.visibility = 'hidden';

    function gapiLoaded() {
      gapi.load('client:picker', initializePicker);
    }

    async function initializePicker() {
      await gapi.client.load('https://www.googleapis.com/discovery/v1/apis/drive/v3/rest');
      pickerInited = true;
      maybeEnableButtons();
    }

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: ''
      });
      gisInited = true;
      maybeEnableButtons();
    }

    function maybeEnableButtons() {
      if (pickerInited && gisInited) {
        document.getElementById('authorize_button').style.visibility = 'visible';
      }
    }

    function handleAuthClick() {
      tokenClient.callback = async (response) => {
        if (response.error !== undefined) throw response;
        accessToken = response.access_token;
        document.getElementById('authorize_button').innerText = 'Google Drive';
        await createPicker();
      };

      if (!accessToken) {
        tokenClient.requestAccessToken({ prompt: 'consent' });
      } else {
        tokenClient.requestAccessToken({ prompt: '' });
      }
    }

    function createPicker() {
      const view = new google.picker.View(google.picker.ViewId.DOCS);
      view.setMimeTypes('application/pdf,image/png,image/jpeg');

      const picker = new google.picker.PickerBuilder()
        .enableFeature(google.picker.Feature.NAV_HIDDEN)
        .enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
        .setDeveloperKey(API_KEY)
        .setAppId(APP_ID)
        .setOAuthToken(accessToken)
        .addView(view)
        .addView(new google.picker.DocsUploadView())
        .setCallback(pickerCallback)
        .build();

      picker.setVisible(true);
    }

    async function pickerCallback(data) {
      if (data.action === google.picker.Action.PICKED) {
        const contentDiv = document.getElementById('content');
        contentDiv.innerHTML = '';

        for (const doc of data.docs) {
          const fileId = doc.id;
          const res = await gapi.client.drive.files.get({
            fileId: fileId,
            fields: 'webViewLink, webContentLink, name',
          });

          const downloadLink = res.result.webContentLink;
          const viewer = document.createElement('iframe');
          viewer.src = downloadLink;
          contentDiv.appendChild(viewer);
        }
      }
    }

    function handleLocalFiles(event) {
      const files = event.target.files;
      const contentDiv = document.getElementById('content');
      contentDiv.innerHTML = '';

      for (const file of files) {
        const reader = new FileReader();
        reader.onload = function () {
          const typedarray = new Uint8Array(reader.result);
          pdfjsLib.getDocument({ data: typedarray }).promise.then(pdf => {
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
              pdf.getPage(pageNum).then(page => {
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                const scale = 1.5;
                const viewport = page.getViewport({ scale: scale });
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                page.render({ canvasContext: context, viewport: viewport });
                contentDiv.appendChild(canvas);
              });
            }
          });
        };
        reader.readAsArrayBuffer(file);
      }
    }

    document.getElementById("dropbox-picker").addEventListener("click", function () {
      Dropbox.choose({
        linkType: "direct",
        multiselect: true,
        extensions: ['.pdf', '.mp4'],
        folderselect: false,
        success: function (files) {
          const contentDiv = document.getElementById("content");
          contentDiv.innerHTML = '';
          files.forEach(file => {
            const iframe = document.createElement('iframe');
            iframe.src = file.link.replace("?dl=0", "?raw=1");
            contentDiv.appendChild(iframe);
          });
        },
        cancel: function () {
          console.log("Dropbox picker canceled");
        }
      });
    });
  </script>

  <!-- Google + Dropbox SDKs -->
  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
  <script type="text/javascript" src="https://www.dropbox.com/static/api/2/dropins.js" id="dropboxjs" data-app-key="3l7z1yycs84fbvu"></script>
</body>
</html>
